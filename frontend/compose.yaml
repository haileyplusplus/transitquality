services:
  transit-sidecar:
    image: ghcr.io/elliotmatson/tailscale-sidecar-proxy:latest
    container_name: transit-sidecar
    hostname: transit
    environment:
      TAILSCALE_AUTH_KEY: ${TS_AUTHKEY_CONFIG}
      TAILSCALE_STATE_DIR: "/var/lib/tailscale"
      TAILSCALE_HOSTNAME: transit
      TAILSCALE_SERVE_PORT: 80
      TAILSCALE_SERVE_SOURCE_MODE: http
      # tailscale serve --bg --https 443 80
      #TS_SOCKET: ${TS_SOCKET}
      #TS_USERSPACE: "false"
    secrets:
      - ts-authkey-secret
    volumes:
      - ${PWD}/ts-authkey-test/state:/var/lib/tailscale
    devices:
      - /dev/net/tun:/dev/net/tun
    cap_add:
      - net_admin
      - sys_module
    restart: unless-stopped
  # tqfrontend:
  #   build:
  #     context: app
  #     target: development
  #   ports:
  #     - 8085:5173
  #   volumes:
  #     - ./app:/project
  #     - /project/node_modules
  #   develop:
  #     watch:
  #       - action: sync
  #         path: ./app
  #         target: /project
  #         ignore:
  #           - node_modules/
  #       - action: rebuild
  #         path: package.json
  transit-frontend:
    build:
      context: transit
      target: development
    volumes:
      - ./transit:/project
      - /project/node_modules
    network_mode: service:transit-sidecar
    depends_on:
      - transit-sidecar
    develop:
      watch:
        - action: sync
          path: ./transit
          target: /project
          ignore:
            - node_modules/
        - action: rebuild
          path: package.json
secrets:
  ts-authkey-secret:
    file: ~/.config/tailscale/ts-authkey-sidecars
